# CHIMERA Security Pipeline
# GitHub Actions workflow for comprehensive security scanning
# Version: 1.0.0
# Created: December 2025

name: Security Pipeline

on:
  push:
    branches: [ master, main ]
  pull_request:
    branches: [ master, main ]
  schedule:
    # Run daily at 00:00 UTC
    - cron: '0 0 * * *'
  workflow_dispatch:

jobs:
  # ===========================================
  # STATIC ANALYSIS
  # ===========================================

  static-analysis:
    name: Static Analysis
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'

    - name: Cache pip dependencies
      uses: actions/cache@v3
      with:
        path: ~/.cache/pip
        key: ${{ runner.os }}-pip-${{ hashFiles('**/requirements*.txt') }}
        restore-keys: |
          ${{ runner.os }}-pip-

    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        pip install -r requirements-dev.txt

    # Bandit - Python security linter
    - name: Run Bandit security linter
      run: |
        pip install bandit[toml]
        bandit -r chimera/ -f json -o bandit-results.json || true

    - name: Upload Bandit results
      uses: actions/upload-artifact@v3
      with:
        name: bandit-results
        path: bandit-results.json

    # Semgrep - Pattern-based security scanning
    - name: Run Semgrep security scan
      uses: returntocorp/semgrep-action@v1
      with:
        config: p/security-audit
        output: semgrep-results.json
      continue-on-error: true

    - name: Upload Semgrep results
      uses: actions/upload-artifact@v3
      with:
        name: semgrep-results
        path: semgrep-results.json

    # MyPy - Type checking for security issues
    - name: Run MyPy type checking
      run: |
        pip install mypy
        mypy chimera/ --ignore-missing-imports --no-strict-optional || true

  # ===========================================
  # SECRET SCANNING
  # ===========================================

  secret-scanning:
    name: Secret Scanning
    runs-on: ubuntu-latest
    timeout-minutes: 15

    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    # TruffleHog - Find leaked credentials
    - name: Run TruffleHog OSS
      uses: trufflesecurity/trufflehog@main
      with:
        path: ./
        base: main
        head: HEAD
        extra_args: --debug --only-verified

    # Gitleaks - Git history scanning
    - name: Run Gitleaks
      uses: gitleaks/gitleaks-action@v2
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      with:
        config-path: .gitleaks.toml

    # GitGuardian - Advanced secret detection
    - name: Run GitGuardian scan
      uses: GitGuardian/ggshield-action@master
      env:
        GITHUB_PUSH_BEFORE_SHA: ${{ github.event.before }}
        GITHUB_PUSH_BASE_SHA: ${{ github.event.after }}
        GITHUB_PULL_BASE_SHA: ${{ github.event.pull_request.base.sha }}
        GITHUB_DEFAULT_BRANCH: ${{ github.event.repository.default_branch }}
        GITGUARDIAN_API_KEY: ${{ secrets.GITGUARDIAN_API_KEY }}
      continue-on-error: true

  # ===========================================
  # DEPENDENCY AUDIT
  # ===========================================

  dependency-audit:
    name: Dependency Audit
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'

    # Python dependencies
    - name: Audit Python dependencies
      run: |
        pip install pip-audit safety
        pip-audit --format json --output pip-audit-results.json || true
        safety check --output safety-results.json || true

    - name: Upload Python audit results
      uses: actions/upload-artifact@v3
      with:
        name: python-audit-results
        path: |
          pip-audit-results.json
          safety-results.json

    # Node.js dependencies (for tracking server)
    - name: Set up Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'

    - name: Audit Node.js dependencies
      working-directory: chimera/tracking_server
      run: |
        npm audit --audit-level moderate --json > npm-audit-results.json || true
        npm install
        npm run security-check || true

    - name: Upload Node.js audit results
      uses: actions/upload-artifact@v3
      with:
        name: nodejs-audit-results
        path: chimera/tracking_server/npm-audit-results.json

    # Container scanning
    - name: Run Trivy vulnerability scanner
      uses: aquasecurity/trivy-action@master
      with:
        scan-type: 'fs'
        scan-ref: '.'
        format: 'sarif'
        output: 'trivy-results.sarif'

    - name: Upload Trivy scan results
      uses: github/codeql-action/upload-sarif@v2
      with:
        sarif_file: 'trivy-results.sarif'

  # ===========================================
  # LICENSE COMPLIANCE
  # ===========================================

  license-compliance:
    name: License Compliance
    runs-on: ubuntu-latest
    timeout-minutes: 5

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    # Licensee - FOSS license checking
    - name: Run Licensee
      run: |
        sudo gem install licensee
        licensee --json > licensee-results.json || true

    - name: Upload Licensee results
      uses: actions/upload-artifact@v3
      with:
        name: licensee-results
        path: licensee-results.json

    # FOSSA - Advanced license scanning
    - name: Run FOSSA scan
      uses: fossas/fossa-action@main
      with:
        api-key: ${{ secrets.FOSSA_API_KEY }}
      continue-on-error: true

  # ===========================================
  # INFRASTRUCTURE SECURITY
  # ===========================================

  infrastructure-security:
    name: Infrastructure Security
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    # Checkov - Infrastructure as Code security
    - name: Run Checkov on Docker files
      uses: bridgecrewio/checkov-action@master
      with:
        framework: dockerfile
        file: docker/
        output_format: json
        output_file_path: checkov-docker-results.json

    - name: Run Checkov on docker-compose
      uses: bridgecrewio/checkov-action@master
      with:
        framework: dockerfile
        file: docker-compose.yml
        output_format: json
        output_file_path: checkov-compose-results.json

    - name: Upload Checkov results
      uses: actions/upload-artifact@v3
      with:
        name: checkov-results
        path: |
          checkov-docker-results.json
          checkov-compose-results.json

    # Hadolint - Dockerfile linting
    - name: Run Hadolint
      uses: hadolint/hadolint-action@v3.1.0
      with:
        dockerfile: docker/*/Dockerfile
        config: .hadolint.yaml

  # ===========================================
  # CODE QUALITY GATES
  # ===========================================

  quality-gates:
    name: Quality Gates
    runs-on: ubuntu-latest
    needs: [static-analysis, secret-scanning, dependency-audit]
    if: always()

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Download all artifacts
      uses: actions/download-artifact@v3
      with:
        path: artifacts/

    # Analyze results and set quality gates
    - name: Analyze security scan results
      run: |
        python scripts/analyze_security_results.py artifacts/

    # Block merge on critical findings
    - name: Check for blocking issues
      run: |
        if [ -f "artifacts/blocking-issues.json" ]; then
          echo "ðŸš¨ BLOCKING SECURITY ISSUES FOUND!"
          cat artifacts/blocking-issues.json
          exit 1
        else
          echo "âœ… No blocking security issues found"
        fi

    # Upload security dashboard
    - name: Upload security dashboard
      uses: actions/upload-artifact@v3
      with:
        name: security-dashboard
        path: artifacts/security-dashboard.html

  # ===========================================
  # COMPLIANCE REPORTING
  # ===========================================

  compliance-reporting:
    name: Compliance Reporting
    runs-on: ubuntu-latest
    needs: [quality-gates]
    if: success()

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Download security results
      uses: actions/download-artifact@v3
      with:
        path: compliance-data/
        name: security-dashboard

    # Generate compliance report
    - name: Generate compliance report
      run: |
        python scripts/generate_compliance_report.py \
          --results compliance-data/ \
          --output compliance-report.pdf

    # Upload compliance report to security tab
    - name: Upload compliance report
      uses: actions/upload-artifact@v3
      with:
        name: compliance-report
        path: compliance-report.pdf

    # Update security dashboard
    - name: Update security dashboard
      if: github.ref == 'refs/heads/master'
      run: |
        # This would integrate with GitHub Security tab
        echo "Security scan completed successfully"

  # ===========================================
  # ALERTING
  # ===========================================

  security-alerting:
    name: Security Alerting
    runs-on: ubuntu-latest
    needs: [quality-gates]
    if: failure()

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    # Create security incident
    - name: Create security alert
      run: |
        echo "ðŸš¨ SECURITY SCAN FAILURE DETECTED!" >> alert.md
        echo "" >> alert.md
        echo "**Repository:** ${{ github.repository }}" >> alert.md
        echo "**Branch:** ${{ github.ref }}" >> alert.md
        echo "**Commit:** ${{ github.sha }}" >> alert.md
        echo "**Workflow:** ${{ github.workflow }}" >> alert.md
        echo "**Run ID:** ${{ github.run_id }}" >> alert.md
        echo "" >> alert.md
        echo "**Action Required:** Review security scan results immediately" >> alert.md

    # Send alert (would integrate with Slack/webhook)
    - name: Send security alert
      run: |
        # Placeholder for alert integration
        cat alert.md
      continue-on-error: true

# ===========================================
# CONFIGURATION
# ===========================================

# Require all jobs to pass
concurrency:
  group: security-${{ github.ref }}
  cancel-in-progress: true

# Security scan results retention
retention-days: 30
